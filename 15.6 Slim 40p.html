<!DOCTYPE html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


<body>
<ng-container>
	<div ng-app="eBay" ng-controller="myCtrl">
		<b>Total items: {{totalItems}}</b>
		<br>
		<b>Total 15.6: {{total156}}</b>
		<br>
		<button ng-click="run(false)">Check</button>
		<button ng-click="run(true)">Revise</button>
		<table class="table">
			<tr>
				<th>{{month}}</th>
				<th>{{year}}</th>
				<th>{{numberOfItems}}</th>
				<th>{{numberOfWarnings}}</th>
				<th>{{numberOfErrors}}</th>
			</tr>
			<tr>
				<th>Month</th>
				<th>Year</th>
				<th>Items</th>
				<th>Warning</th>
				<th>Error</th>
			</tr>
			<tr ng-repeat = "res in result">
				<th>{{res.month}}</th>
				<th>{{res.year}}</th>
				<th>{{res.numberOfItems}}</th>
				<th>{{res.numberOfWarnings}}</th>
				<th>{{res.numberOfErrors}}</th>
			</tr>
		</table>
		<div id="descList"></div>
	</div>
	</ng-container>
</body>

<script>
	var app = angular.module("eBay", []); 
	app.controller("myCtrl", function($scope, $http) {
		appId = 'PhinkNg-EbayChan-PRD-b08fef0ab-ae0ce710';
		token = 'v^1.1#i^1#r^0#I^3#f^0#p^3#t^H4sIAAAAAAAAAOVXbWwTZRxfuxeCMNQIMglLuhuQILn2ee56veuFVstWZBG2SseQF1meu3tuPXa9K3fXbYVExiIj6geNkhE/iExeEgwJYCCiBgKogImEmAhoDEHjBzBRIMSgMWp8rnvrZgS2kbjEfmhz/+f/9vv9f8/Te0Bn2eQnu5d0/1rumeTd1Qk6vR4PnAIml5UumFbsnVVaBAocPLs653SWdBVfX2ijtJ4Rl2M7Yxo29nWkdcMW88YIlbUM0US2ZosGSmNbdGQxGVu2VGT8QMxYpmPKpk756mojFC/wDOAUSeYkISghSKzGQM5GM0KpAlYYFUIFASDxIUDWbTuL6wzbQYYToRgAeRrwNMM1AkEEnMgG/UyYWU35mrBla6ZBXPyAiubbFfOxVkGvd28V2Ta2HJKEitbFFicbYnW18frGhYGCXNF+HpIOcrL28KcaU8G+JqRn8d3L2HlvMZmVZWzbVCDaV2F4UjE20MwY2s9TLXAsF+RCfFDg5BCWHwiTi00rjZy7t+FaNIVW864iNhzNyd2LUEKGtB7LTv9TPUlRV+tzf57LIl1TNWxFqPii2KoVyfhyypdMJCyzTVOw4gKFIMxDIQQB6TaT0oxW0+9gOWWYutmSIzBhf8G+rP1sj6hYYxqK5nJn++pNZxEm3ePhHPEiV8ARcWowGqyY6ridFfhBMMClwK12Z9s3zKyTMtzx4jQhxJd/vPckBpQxpIUHpQ2eE9QQkqDKsQyUVG5IHO5eH7tAou6MYolEwO0FSyhHp5HVip2MjmRMy4TebBpbmiKynMqwgoppJRRW6WBYVWmJU0I0VDEGGEuSHBb+jzpxHEuTsg4e1MrIhTzYCJWUzQxOmLom56iRLvkjqF8ZHXaESjlORgwE2tvb/e2s37RaAgwAMPD8sqVJOYXTiBr01e7tTGt52cqYRNma6OQypJsOIkFS3GihoqylJJDl5JJY14lhQMDDeouOtP4LSNsFObHgufE2SYAymt/Vt1820wETkf3smprzHfvuxylgE4L8fbuDZPZbGCmmoefGEjyKGM1oI6IyrZxb0N3roy06mGAUMUiWzazhjAVjf+goItSsrmq67u6dsRQsCB9NmwbSc44m24MlxyX8WCZTp0ws4SfcA7O+hY4THmpSyKATy2tpCZAjXAVIohEGMuYhGBdsBbdpMm7WJhh0I6vr48JVi9v+83GSvf7UCFy8oKIgDDN0UGABHeTJVxhjlmaDHAyxqiwzeHzzXNYy0UYphFmGY9lQCAB+XNBqdI2cEI25ifb/tMS0HayMDxp5UZxYoNyjZuCkCcoKpMNQIqqVBYFGisrSPAfY+4U8wlDwnvWPV+3A8CtvtCj/gV2eo6DLc5jcmkEAzIXVoKqseEVJ8dRZtuZgv4ZUv621GOQmZ2F/K85lkGZ5yzxrZh/a31xwyd71AqgYvGZPLoZTCu7cYPbQSil8eGY55AHPcEAAHBtcDaqHVkvg4yXTf367Z/v2yNbclo0rYXy6Z8OWWesqQfmgk8dTWlTS5Sn65NSeODf/Sk/Vjg/OgL8unb3QMG/hglNXb11gts8uX9Ajfoiq0j3SzncaW9c+cfN2b9mV6iV7oxfhW5NWrTv27vmvMrgXvXbkzsdbtwS/PFu5v0m+zFdcz914vyf+7IXfe/d0/7G5+/itxmmXL+G1K2acOnD6ROXTmfe+vgPampuPM76upjk7Tz7y28b9B+fHOpq2/fhmx+19O757DH77etBM5V484X30h5eqNnwWnbHv0CYKqPT0zw/NW7M7tOnAq73fewPnzp156Jl4pXN65k9fHAlf+7RzhtD0zS9/nn5lr1xxdNEbK+dXXzx/Y85Hx0rmTj15VLt68uVr6w/bc6VtFetulibikw7CE97dm/vG9zenzben/hAAAA==';
		$http.defaults.headers.common['X-EBAY-API-SITEID'] = '15';
		$http.defaults.headers.common['X-EBAY-API-REQUEST-ENCODING'] = 'XML';
		$http.defaults.headers.common['X-EBAY-API-COMPATIBILITY-LEVEL'] = '967';
		$http.defaults.headers.common['X-EBAY-API-IAF-TOKEN'] = token;
		
		parser = new DOMParser();
		$scope.totalItems = 0;
		$scope.total156 = 0;
		$scope.result = [];
		$scope.revise = false;
		const FROM_MONTH = 1;
		const FROM_YEAR = 2012;
		const TO_MONTH = 12;
		const TO_YEAR = 2013;
		
		month2Text = function (month) {
			if (month < 10)
				return "0" + month;
			else
				return month;
		}
		
		$scope.run = function (revise) {
			$scope.month = FROM_MONTH;
			$scope.year = FROM_YEAR;
			$scope.revise = revise
			nextMonth();
			//requestReviseItem("321234518050", "");
		};
		
		nextMonth = function () {
			if (($scope.year == TO_YEAR) && ($scope.month == TO_MONTH))  {
				console.log("FINISHED ALL JOB");
				return;
			} 
			if ($scope.month < 12) {
				$scope.month++;
			} else {
				$scope.month = 1;
				$scope.year++;
			}
			
			// '2017-03-01T06:38:48.420Z'	
			sample = "-01T06:38:48.420Z";
			console.log("RUNNING " + month2Text($scope.month) + "/" + $scope.year);
			$scope.numberOfItems = 0;
			$scope.numberOfWarnings = 0;
			$scope.numberOfErrors = 0;
			if ($scope.month < 12) {
				requestSellerList($scope.year + '-' + month2Text($scope.month) + sample, $scope.year + '-' + month2Text($scope.month + 1) + sample, 1);
			} else {
				requestSellerList($scope.year + '-12' + sample, ($scope.year + 1) + '-01'  + sample, 1);
			}
		}
		
		requestSellerList = function (dateFrom, dateTo, pageNumber) {
			console.log("BEGIN\ndateFrom: " + dateFrom + "\ndateTo: " + dateTo + "\npageNumber: " + pageNumber);
			$http.defaults.headers.common['X-EBAY-API-CALL-NAME'] = 'GetSellerList';
			url = 'https://api.ebay.com/ws/api.dll';
			data = requestSellerListBuilder(dateFrom, dateTo, pageNumber);
			$http.post(url, data).then(function(res) {
				//console.log(res);
				descList = document.getElementById("descList");
				xml = parser.parseFromString(res.data, "application/xml").childNodes[0];
				items = xml.getElementsByTagName("Item");
				$scope.totalItems += items.length;
				$scope.numberOfItems += items.length;	
				
				for (var i=0; i < items.length; i++) {
					item = items[i];
					desc = item.getElementsByTagName("Description")[0].childNodes[0].nodeValue;
					id = item.getElementsByTagName("ItemID")[0].childNodes[0].nodeValue;
					picUrl = item.getElementsByTagName("PictureURL")[0].childNodes[0].nodeValue;
					price = item.getElementsByTagName("CurrentPrice")[0].childNodes[0].nodeValue;
					//trimmedDesc = trimContactDetail(desc);
					
					if (listingIs156(desc, price, id)) {
						$scope.total156++;
						//console.log(id + " " + price);
						if ($scope.revise) {
							//requestReviseItem(id, "");
						}  {
							descEle = document.createElement("p");
							descEle.innerHTML = desc;
							idEle = document.createElement("h1");
							idEle.appendChild(document.createTextNode(id + "     " + price + "\n" + picUrl));
							picEle = document.createElement("img");
							picEle.src = picUrl;
							descList.appendChild(idEle);
							descList.appendChild(picEle);
							descList.appendChild(descEle);
						}
					}
					
					//requestReviseItem(id, trimmedDesc);
				}
				
				hasMoreItems = xml.getElementsByTagName("HasMoreItems");
				if (hasMoreItems.length > 0) {
					//console.log("hasMoreItems", hasMoreItems[0].childNodes[0].nodeValue);
					if (hasMoreItems[0].childNodes[0].nodeValue == "true") {
						requestSellerList(dateFrom, dateTo, pageNumber + 1);
					}
					else {
						console.log("FINISHED");
						$scope.result.push({
							month: $scope.month, 
							year: $scope.year, 
							numberOfItems: $scope.numberOfItems,
							numberOfWarnings: $scope.numberOfWarnings,
							numberOfErrors: $scope.numberOfErrors});
						nextMonth();
					}
				}
				else {
					console.log("FINISHED");
					$scope.result.push({
						month: $scope.month, 
						year: $scope.year, 
						numberOfItems: $scope.numberOfItems,
						numberOfWarnings: $scope.numberOfWarnings,
						numberOfErrors: $scope.numberOfErrors});
					nextMonth();
				}
			}, function (error) {
				console.log(error);
			});
		}
		
		requestReviseItem = function (itemNumber, description) {
			$http.defaults.headers.common['X-EBAY-API-CALL-NAME'] = 'ReviseItem';
			url = 'https://api.ebay.com/ws/api.dll';
			data = requestReviseItemBuilder(itemNumber, description);
			$http.post(url, data).then(function(res) {
				xml = parser.parseFromString(res.data, "application/xml").childNodes[0];
				ack = xml.getElementsByTagName("Ack");
				msg = ack[0].childNodes[0].nodeValue;
				if (msg == "Warning") {
					$scope.numberOfWarnings++;
					//console.log(res);
				} else if (msg == "Error") {
					$scope.numberOfErrors++;
					console.log(res);
				}
				console.log(res);
			}, function (error) {
				console.log(error);
			});
		};
		
		requestSellerListBuilder = function (dateFrom, dateTo, pageNumber) {
			request = "<?xml version='1.0' encoding='utf-8'?>" + "\n"
					+ "<GetSellerListRequest xmlns='urn:ebay:apis:eBLBaseComponents'>" + "\n"
					+ "<ErrorLanguage>en_US</ErrorLanguage>" + "\n"
					+ "		<WarningLevel>High</WarningLevel>" + "\n"
					+ "	  <DetailLevel>ItemReturnDescription</DetailLevel>" + "\n"
					+ "	  <StartTimeFrom>" + dateFrom + "</StartTimeFrom>" + "\n"
					+ "	  <StartTimeTo>" + dateTo + "</StartTimeTo>" + "\n"
					+ "	  <Pagination>" + "\n"
					+ "		<EntriesPerPage>40</EntriesPerPage>" + "\n"
					+ "		<PageNumber>" + pageNumber + "</PageNumber>" + "\n"
					+ "	  </Pagination>" + "\n"
					+ "	 <OutputSelector>HasMoreItems</OutputSelector>" + "\n"
					+ "  <OutputSelector>ItemId</OutputSelector>" + "\n"
					+ "	 <OutputSelector>Description</OutputSelector>" + "\n"
					+ "	 <OutputSelector>PictureURL</OutputSelector>" + "\n"
					+ "	 <OutputSelector>SellingStatus</OutputSelector>" + "\n"
					+ "	 <OutputSelector>ReturnedItemCountActual</OutputSelector>" + "\n"
					+ "	</GetSellerListRequest>";
			return request;
		}
		
		requestReviseItemBuilder = function (itemNumber, description) {
			request = "<?xml version='1.0' encoding='utf-8'?>" + "\n"
					+ "<ReviseItemRequest xmlns='urn:ebay:apis:eBLBaseComponents'>" + "\n" 
					+ "<ErrorLanguage>en_US</ErrorLanguage>" + "\n"
					+ "		<WarningLevel>High</WarningLevel>" + "\n"
					+ "	  <Item>" + "\n"
					+ "		<ItemID>" + itemNumber + "</ItemID>" + "\n"
					//+ "		<Description><![CDATA[" + description + "]]></Description>" + "\n"
					+ "		<DescriptionReviseMode>Replace</DescriptionReviseMode>" + "\n"
					+ "		<PictureDetails>" + "\n"
					+ "			<GalleryDuration>Lifetime</GalleryDuration>" + "\n"
					+ "			<GalleryType>Gallery</GalleryType>" + "\n"
					+ "			<PhotoDisplay>SuperSize</PhotoDisplay>" + "\n"
					+ "			<PictureURL>http://phinkotechnology.com.au/image/ebay/15.6_30p_1.jpg</PictureURL>" + "\n"
					+ "			<PictureURL>http://phinkotechnology.com.au/image/ebay/15.6_30p_2.jpg</PictureURL>" + "\n"
					+ "	    </PictureDetails>" + "\n"
					+ "	  </Item>" + "\n"
					+ "	</ReviseItemRequest>";
			return request;
		}  
		
		keyText = ['Size: 15.6 Inch Widescreen',
					'Resolution: WXGA (1366*768)',
					'Resolution: WXGA+ (1366*768)HD',
					'Finish: High Gloss Anti-Reflective',
					'Backlight Type: LED Backlight', 
					'Condition: New Grade A+',
					'40 PIN'];
		banText = ['Digitizer', 'digitizer', '30 pin', 'LP156WH4 (TL)(A1)', 'LTN156AT05', 'LTN156AT02', 'B156XW02', 'LP156WH2', 'N133I6-L09'];
		listingIs156 = function (desc, price, id) {
			if (price < 70)
				return false;
				
			res = 0;
			keyText.forEach(function(text) {
				if (desc.indexOf(text) != -1)
					res += 0.2;
			});
			banText.forEach(function(text) {
				if (desc.indexOf(text) != -1)
					res -= 0.5;
			});
			//console.log(id + "  " + res);
			return (res >= 1);
		}
		
		removingText = ['fbcdn', '0431028789', 'phinko', 'Contact', 'CONTACT', 'PLEASE CONTACT', 'PHINKO', 'Phinko', 'Email', 'DETAIL', '24', '24 hours service', 'for more'];
		trimContactDetail = function (desc) {
			removingText.forEach(function(text) {
				length = text.length;
				while (desc.indexOf(text) != -1) {
					left = desc.indexOf(text) - 1;
					right = left + length + 2;
					while (desc.charAt(left) != '>')
						left--;
					while (desc.charAt(right) != '<') 
						right++;
					temp = desc.substr(0, left) + desc.substr(right,desc.length);
					desc = temp;
				}
			});
			//desc = desc.replace('<br>', '<br></br>');
			//console.log(desc);
			return desc;
		}
	});
</script>

